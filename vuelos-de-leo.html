<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vuelos de Leo - Shooter Prehist√≥rico</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #000022 0%, #000044 50%, #000066 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .game-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 20px;
            background: linear-gradient(180deg, #333366 0%, #222244 100%);
            border: 3px solid #6666aa;
            border-radius: 10px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            font-size: 8px;
            color: #aaaaff;
        }

        .stat-value {
            font-size: 14px;
            color: #ffffff;
            text-shadow: 2px 2px 0 #000;
        }

        .health-bar {
            width: 150px;
            height: 20px;
            background: #330000;
            border: 2px solid #ff0000;
            border-radius: 3px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(180deg, #ff0000 0%, #aa0000 50%, #ff0000 100%);
            transition: width 0.3s;
        }

        .weapon-display {
            padding: 5px 15px;
            background: linear-gradient(180deg, #004400 0%, #002200 100%);
            border: 2px solid #00ff00;
            border-radius: 5px;
            color: #00ff00;
            font-size: 10px;
        }

        #gameCanvas {
            border: 4px solid #6666aa;
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(100, 100, 255, 0.5), inset 0 0 50px rgba(0, 0, 0, 0.5);
            cursor: crosshair;
        }

        .start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: linear-gradient(180deg, rgba(0, 0, 50, 0.95) 0%, rgba(0, 0, 100, 0.95) 100%);
            padding: 40px;
            border: 4px solid #6666ff;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(100, 100, 255, 0.8);
        }

        .game-title {
            font-size: 28px;
            color: #ffff00;
            text-shadow: 3px 3px 0 #ff6600, 6px 6px 0 #000;
            margin-bottom: 10px;
            animation: titlePulse 1s ease-in-out infinite alternate;
        }

        @keyframes titlePulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .game-subtitle {
            font-size: 12px;
            color: #66aaff;
            margin-bottom: 30px;
        }

        .instructions {
            font-size: 8px;
            color: #aaaaaa;
            line-height: 2;
            margin-bottom: 30px;
            text-align: left;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
        }

        .btn {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            padding: 15px 30px;
            margin: 10px;
            cursor: pointer;
            border: 3px solid;
            border-radius: 5px;
            transition: all 0.2s;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }

        .btn-play {
            background: linear-gradient(180deg, #00aa00 0%, #006600 100%);
            border-color: #00ff00;
            color: #ffffff;
        }

        .btn-back {
            background: linear-gradient(180deg, #666666 0%, #444444 100%);
            border-color: #888888;
            color: #ffffff;
            font-size: 10px;
            padding: 10px 20px;
        }

        .game-over-screen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: linear-gradient(180deg, rgba(50, 0, 0, 0.95) 0%, rgba(100, 0, 0, 0.95) 100%);
            padding: 40px;
            border: 4px solid #ff0000;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.8);
        }

        .victory-screen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: linear-gradient(180deg, rgba(0, 50, 0, 0.95) 0%, rgba(0, 100, 0, 0.95) 100%);
            padding: 40px;
            border: 4px solid #00ff00;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.8);
        }

        .screen-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
        }

        .final-score {
            font-size: 16px;
            color: #ffff00;
            margin-bottom: 30px;
        }

        .hidden {
            display: none !important;
        }

        .paused-overlay {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #ffff00;
            text-shadow: 4px 4px 0 #000;
            z-index: 50;
            animation: pauseBlink 0.5s ease-in-out infinite alternate;
        }

        @keyframes pauseBlink {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }

        .level-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #00ffff;
            text-shadow: 3px 3px 0 #000;
            z-index: 40;
            display: none;
            animation: levelPop 0.5s ease-out;
        }

        @keyframes levelPop {
            from { transform: translate(-50%, -50%) scale(2); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="game-header">
            <div class="stat">
                <span class="stat-label">PUNTOS</span>
                <span class="stat-value" id="scoreDisplay">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">VIDA</span>
                <div class="health-bar">
                    <div class="health-fill" id="healthBar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat">
                <span class="stat-label">ARMA</span>
                <div class="weapon-display" id="weaponDisplay">AMETRALLADORA</div>
            </div>
            <div class="stat">
                <span class="stat-label">NIVEL</span>
                <span class="stat-value" id="levelDisplay">1</span>
            </div>
        </div>

        <div style="position: relative;">
            <canvas id="gameCanvas" width="600" height="700"></canvas>

            <div class="start-screen" id="startScreen">
                <h1 class="game-title">VUELOS DE LEO</h1>
                <p class="game-subtitle">‚öîÔ∏è SHOOTER PREHIST√ìRICO ‚öîÔ∏è</p>

                <div class="instructions">
                    <p>üéÆ CONTROLES:</p>
                    <p>‚Üê ‚Üí ‚Üë ‚Üì : MOVER AVI√ìN</p>
                    <p>ESPACIO : DISPARAR</p>
                    <p>P : PAUSAR</p>
                    <br>
                    <p>üéØ 7 NIVELES DE ACCI√ìN:</p>
                    <p>DESTRUYE PTEROSAURIOS</p>
                    <p>RECOGE HUEVOS = VIDA</p>
                    <p>9 ARMAS DIFERENTES</p>
                    <p>BOSS FINAL: MEGA QUETZALCOATLUS</p>
                </div>

                <button class="btn btn-play" onclick="startGame()">‚ñ∂ DESPEGAR</button>
                <br><br>
                <a href="juegos.html" class="btn btn-back">‚Üê VOLVER</a>
            </div>

            <div class="game-over-screen" id="gameOverScreen">
                <h2 class="screen-title" style="color: #ff0000;">GAME OVER</h2>
                <p style="color: #ff6666; font-size: 10px; margin-bottom: 20px;">TU AVI√ìN HA SIDO DESTRUIDO</p>
                <p class="final-score">PUNTUACI√ìN: <span id="finalScore">0</span></p>
                <p style="color: #aaaaaa; font-size: 10px; margin-bottom: 20px;">PTEROSAURIOS DERROTADOS: <span id="killCount">0</span></p>
                <button class="btn btn-play" onclick="startGame()">REINTENTAR</button>
                <br><br>
                <a href="juegos.html" class="btn btn-back">‚Üê VOLVER</a>
            </div>

            <div class="victory-screen" id="victoryScreen">
                <h2 class="screen-title" style="color: #00ff00;">¬°VICTORIA!</h2>
                <p style="color: #66ff66; font-size: 10px; margin-bottom: 20px;">HAS DOMINADO LOS CIELOS</p>
                <p class="final-score">PUNTUACI√ìN: <span id="victoryScore">0</span></p>
                <p style="color: #aaaaaa; font-size: 10px; margin-bottom: 20px;">PTEROSAURIOS DERROTADOS: <span id="victoryKills">0</span></p>
                <button class="btn btn-play" onclick="startGame()">JUGAR DE NUEVO</button>
                <br><br>
                <a href="juegos.html" class="btn btn-back">‚Üê VOLVER</a>
            </div>

            <div class="paused-overlay" id="pausedOverlay">PAUSA</div>
            <div class="level-display" id="levelPopup"></div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN DEL JUEGO =====
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Estado del juego
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let level = 1;
        let killCount = 0;
        let difficultyMultiplier = 1;

        // Jugador
        let player = {
            x: 300,
            y: 600,
            width: 50,
            height: 60,
            speed: 6,
            health: 100,
            maxHealth: 100,
            weapon: 'machinegun',
            weaponLevel: 1,
            invulnerable: false,
            invulnerableTime: 0
        };

        // Arrays del juego
        let bullets = [];
        let enemies = [];
        let powerups = [];
        let particles = [];
        let explosions = [];
        let clouds = [];

        // Controles
        let keys = {};

        // Timing
        let lastShot = 0;
        let shootDelay = 150;
        let lastEnemySpawn = 0;
        let enemySpawnDelay = 1500;
        let lastPowerupSpawn = 0;
        let powerupSpawnDelay = 8000;

        // Definici√≥n de armas
        const weapons = {
            machinegun: { name: 'AMETRALLADORA', delay: 150, damage: 10, color: '#ffff00', sound: 'shoot' },
            double: { name: 'DOBLE', delay: 150, damage: 10, color: '#00ff00', sound: 'shoot' },
            spread: { name: 'DISPERSI√ìN', delay: 200, damage: 8, color: '#00ffff', sound: 'shoot' },
            laser: { name: 'L√ÅSER', delay: 100, damage: 15, color: '#ff00ff', sound: 'laser' },
            missile: { name: 'MISILES', delay: 400, damage: 30, color: '#ff6600', sound: 'missile' },
            plasma: { name: 'PLASMA', delay: 120, damage: 20, color: '#00ffaa', sound: 'laser' },
            flame: { name: 'LANZALLAMAS', delay: 50, damage: 5, color: '#ff3300', sound: 'shoot' },
            lightning: { name: 'RAYO', delay: 300, damage: 25, color: '#aaaaff', sound: 'laser' },
            bomb: { name: 'BOMBAS', delay: 600, damage: 80, color: '#ff0000', sound: 'missile' }
        };

        // Configuraci√≥n de los 7 niveles
        const levelConfig = {
            1: { name: 'CIELOS TRANQUILOS', kills: 8, spawnDelay: 2000, types: ['pteranodon', 'dimorphodon'], multiplier: 1.0 },
            2: { name: 'ZONA DE CAZA', kills: 12, spawnDelay: 1800, types: ['pteranodon', 'dimorphodon', 'rhamphorhynchus'], multiplier: 1.15 },
            3: { name: 'TERRITORIO HOSTIL', kills: 15, spawnDelay: 1500, types: ['pteranodon', 'dimorphodon', 'rhamphorhynchus', 'anhanguera'], multiplier: 1.3 },
            4: { name: 'NIDO DE GIGANTES', kills: 18, spawnDelay: 1300, types: ['dimorphodon', 'rhamphorhynchus', 'anhanguera', 'quetzalcoatlus'], multiplier: 1.5 },
            5: { name: 'TORMENTA PREHIST√ìRICA', kills: 20, spawnDelay: 1100, types: ['pteranodon', 'dimorphodon', 'rhamphorhynchus', 'anhanguera', 'quetzalcoatlus'], multiplier: 1.7 },
            6: { name: 'INFIERNO JUR√ÅSICO', kills: 25, spawnDelay: 900, types: ['rhamphorhynchus', 'anhanguera', 'quetzalcoatlus'], multiplier: 2.0 },
            7: { name: 'REY DE LOS CIELOS', kills: 1, spawnDelay: 5000, types: ['boss'], multiplier: 2.5, boss: true }
        };

        let levelKills = 0; // Kills en el nivel actual
        let boss = null; // Boss del nivel 7

        // ===== SISTEMA DE AUDIO =====
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            if (!audioCtx || audioCtx.state !== 'running') return;

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                switch(type) {
                    case 'shoot':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.1);
                        break;

                    case 'laser':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.15);
                        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.15);
                        break;

                    case 'missile':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.3);
                        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.3);
                        break;

                    case 'explosion':
                        const noise = audioCtx.createBufferSource();
                        const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.3, audioCtx.sampleRate);
                        const output = noiseBuffer.getChannelData(0);
                        for (let i = 0; i < noiseBuffer.length; i++) {
                            output[i] = Math.random() * 2 - 1;
                        }
                        noise.buffer = noiseBuffer;
                        const noiseGain = audioCtx.createGain();
                        noiseGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        const filter = audioCtx.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.setValueAtTime(1000, audioCtx.currentTime);
                        filter.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                        noise.connect(filter);
                        filter.connect(noiseGain);
                        noiseGain.connect(audioCtx.destination);
                        noise.start();
                        break;

                    case 'hit':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.1);
                        break;

                    case 'powerup':
                        const notes = [523, 659, 784, 1047];
                        notes.forEach((freq, i) => {
                            setTimeout(() => {
                                const o = audioCtx.createOscillator();
                                const g = audioCtx.createGain();
                                o.type = 'sine';
                                o.frequency.value = freq;
                                g.gain.setValueAtTime(0.15, audioCtx.currentTime);
                                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                                o.connect(g);
                                g.connect(audioCtx.destination);
                                o.start();
                                o.stop(audioCtx.currentTime + 0.1);
                            }, i * 50);
                        });
                        break;

                    case 'damage':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.2);
                        break;

                    case 'gameover':
                        const goNotes = [400, 350, 300, 250, 200];
                        goNotes.forEach((freq, i) => {
                            setTimeout(() => {
                                const o = audioCtx.createOscillator();
                                const g = audioCtx.createGain();
                                o.type = 'sawtooth';
                                o.frequency.value = freq;
                                g.gain.setValueAtTime(0.2, audioCtx.currentTime);
                                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                                o.connect(g);
                                g.connect(audioCtx.destination);
                                o.start();
                                o.stop(audioCtx.currentTime + 0.3);
                            }, i * 200);
                        });
                        break;

                    case 'levelup':
                        const luNotes = [523, 659, 784, 1047, 1319];
                        luNotes.forEach((freq, i) => {
                            setTimeout(() => {
                                const o = audioCtx.createOscillator();
                                const g = audioCtx.createGain();
                                o.type = 'square';
                                o.frequency.value = freq;
                                g.gain.setValueAtTime(0.15, audioCtx.currentTime);
                                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                                o.connect(g);
                                g.connect(audioCtx.destination);
                                o.start();
                                o.stop(audioCtx.currentTime + 0.15);
                            }, i * 80);
                        });
                        break;
                }
            } catch(e) {
                console.log('Audio error:', e);
            }
        }

        // ===== TIPOS DE PTEROSAURIOS =====
        const pterosaurTypes = {
            pteranodon: {
                name: 'Pteranodon',
                width: 60,
                height: 50,
                health: 20,
                speed: 2,
                points: 100,
                color: '#8B4513',
                pattern: 'straight'
            },
            dimorphodon: {
                name: 'Dimorphodon',
                width: 40,
                height: 35,
                health: 10,
                speed: 4,
                points: 150,
                color: '#228B22',
                pattern: 'zigzag'
            },
            quetzalcoatlus: {
                name: 'Quetzalcoatlus',
                width: 90,
                height: 70,
                health: 60,
                speed: 1.5,
                points: 300,
                color: '#4B0082',
                pattern: 'straight'
            },
            rhamphorhynchus: {
                name: 'Rhamphorhynchus',
                width: 50,
                height: 45,
                health: 25,
                speed: 3,
                points: 200,
                color: '#B22222',
                pattern: 'dive'
            },
            anhanguera: {
                name: 'Anhanguera',
                width: 55,
                height: 48,
                health: 30,
                speed: 2.5,
                points: 250,
                color: '#FF8C00',
                pattern: 'swoop'
            },
            boss: {
                name: 'MEGA QUETZALCOATLUS',
                width: 180,
                height: 140,
                health: 500,
                speed: 1,
                points: 5000,
                color: '#8B0000',
                pattern: 'boss'
            }
        };

        // ===== DIBUJAR AVI√ìN =====
        function drawPlayer() {
            ctx.save();

            // Parpadeo si invulnerable
            if (player.invulnerable && Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.globalAlpha = 0.5;
            }

            const x = player.x;
            const y = player.y;

            // Llamas del motor
            const flameHeight = 15 + Math.random() * 10;
            ctx.fillStyle = '#ff6600';
            ctx.beginPath();
            ctx.moveTo(x - 8, y + 25);
            ctx.lineTo(x, y + 25 + flameHeight);
            ctx.lineTo(x + 8, y + 25);
            ctx.fill();

            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.moveTo(x - 4, y + 25);
            ctx.lineTo(x, y + 25 + flameHeight * 0.6);
            ctx.lineTo(x + 4, y + 25);
            ctx.fill();

            // Cuerpo principal (fuselaje)
            ctx.fillStyle = '#3366cc';
            ctx.beginPath();
            ctx.moveTo(x, y - 30);
            ctx.lineTo(x + 12, y + 10);
            ctx.lineTo(x + 10, y + 25);
            ctx.lineTo(x - 10, y + 25);
            ctx.lineTo(x - 12, y + 10);
            ctx.closePath();
            ctx.fill();

            // Alas principales
            ctx.fillStyle = '#4477dd';
            ctx.beginPath();
            ctx.moveTo(x - 10, y);
            ctx.lineTo(x - 35, y + 15);
            ctx.lineTo(x - 30, y + 20);
            ctx.lineTo(x - 8, y + 10);
            ctx.closePath();
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(x + 10, y);
            ctx.lineTo(x + 35, y + 15);
            ctx.lineTo(x + 30, y + 20);
            ctx.lineTo(x + 8, y + 10);
            ctx.closePath();
            ctx.fill();

            // Cabina
            ctx.fillStyle = '#66ffff';
            ctx.beginPath();
            ctx.ellipse(x, y - 10, 6, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Cola
            ctx.fillStyle = '#2255aa';
            ctx.beginPath();
            ctx.moveTo(x - 5, y + 20);
            ctx.lineTo(x - 15, y + 30);
            ctx.lineTo(x + 15, y + 30);
            ctx.lineTo(x + 5, y + 20);
            ctx.closePath();
            ctx.fill();

            // Detalles met√°licos
            ctx.strokeStyle = '#aaccff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y - 25);
            ctx.lineTo(x, y + 20);
            ctx.stroke();

            // Ca√±ones
            ctx.fillStyle = '#333333';
            ctx.fillRect(x - 18, y + 5, 4, 12);
            ctx.fillRect(x + 14, y + 5, 4, 12);

            ctx.restore();
        }

        // ===== DIBUJAR PTEROSAURIO =====
        function drawPterosaurus(enemy) {
            ctx.save();
            ctx.translate(enemy.x, enemy.y);

            const type = pterosaurTypes[enemy.type];
            const wingFlap = Math.sin(Date.now() / 100 + enemy.id) * 15;

            // Alas
            ctx.fillStyle = type.color;
            ctx.beginPath();
            // Ala izquierda
            ctx.moveTo(-5, 0);
            ctx.quadraticCurveTo(-type.width/2 - 10, -10 + wingFlap, -type.width/2, 5 + wingFlap);
            ctx.quadraticCurveTo(-type.width/3, 10, -5, 5);
            ctx.fill();

            // Ala derecha
            ctx.beginPath();
            ctx.moveTo(5, 0);
            ctx.quadraticCurveTo(type.width/2 + 10, -10 + wingFlap, type.width/2, 5 + wingFlap);
            ctx.quadraticCurveTo(type.width/3, 10, 5, 5);
            ctx.fill();

            // Cuerpo
            ctx.fillStyle = type.color;
            ctx.beginPath();
            ctx.ellipse(0, 5, 12, 18, 0, 0, Math.PI * 2);
            ctx.fill();

            // Cabeza y cresta
            ctx.beginPath();
            ctx.ellipse(0, -15, 8, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Cresta (var√≠a seg√∫n tipo)
            if (enemy.type === 'pteranodon' || enemy.type === 'quetzalcoatlus') {
                ctx.beginPath();
                ctx.moveTo(0, -20);
                ctx.lineTo(-20, -25);
                ctx.lineTo(0, -15);
                ctx.fill();
            }

            // Pico
            ctx.fillStyle = '#ffcc00';
            ctx.beginPath();
            ctx.moveTo(0, -15);
            ctx.lineTo(-3, -10);
            ctx.lineTo(0, 5);
            ctx.lineTo(3, -10);
            ctx.closePath();
            ctx.fill();

            // Ojos
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(-4, -18, 3, 0, Math.PI * 2);
            ctx.arc(4, -18, 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-4, -18, 1.5, 0, Math.PI * 2);
            ctx.arc(4, -18, 1.5, 0, Math.PI * 2);
            ctx.fill();

            // Patas
            ctx.strokeStyle = type.color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(-5, 20);
            ctx.lineTo(-8, 30);
            ctx.moveTo(5, 20);
            ctx.lineTo(8, 30);
            ctx.stroke();

            // Barra de vida
            const healthPercent = enemy.health / pterosaurTypes[enemy.type].health;
            ctx.fillStyle = '#330000';
            ctx.fillRect(-20, -35, 40, 6);
            ctx.fillStyle = healthPercent > 0.5 ? '#00ff00' : healthPercent > 0.25 ? '#ffff00' : '#ff0000';
            ctx.fillRect(-20, -35, 40 * healthPercent, 6);

            ctx.restore();
        }

        // ===== DIBUJAR HUEVO CON ALAS =====
        function drawHealthEgg(powerup) {
            ctx.save();
            ctx.translate(powerup.x, powerup.y);

            const wingFlap = Math.sin(Date.now() / 80) * 20;

            // Alas peque√±as
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.ellipse(-18, wingFlap/3, 15, 8, -0.3 + wingFlap/50, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(18, wingFlap/3, 15, 8, 0.3 - wingFlap/50, 0, Math.PI * 2);
            ctx.fill();

            // Huevo
            ctx.fillStyle = '#ffeecc';
            ctx.beginPath();
            ctx.ellipse(0, 0, 15, 20, 0, 0, Math.PI * 2);
            ctx.fill();

            // Brillo
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.ellipse(-5, -8, 4, 6, -0.3, 0, Math.PI * 2);
            ctx.fill();

            // Cruz de vida
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(-3, -10, 6, 20);
            ctx.fillRect(-10, -3, 20, 6);

            // Aura
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, 25 + Math.sin(Date.now() / 200) * 5, 0, Math.PI * 2);
            ctx.stroke();

            ctx.restore();
        }

        // ===== DIBUJAR POWER-UP DE ARMA =====
        function drawWeaponPowerup(powerup) {
            ctx.save();
            ctx.translate(powerup.x, powerup.y);

            const pulse = Math.sin(Date.now() / 150) * 3;

            // Caja
            ctx.fillStyle = '#444488';
            ctx.fillRect(-18 - pulse, -15 - pulse, 36 + pulse*2, 30 + pulse*2);

            ctx.strokeStyle = '#8888ff';
            ctx.lineWidth = 3;
            ctx.strokeRect(-18 - pulse, -15 - pulse, 36 + pulse*2, 30 + pulse*2);

            // S√≠mbolo de arma
            ctx.fillStyle = weapons[powerup.weaponType].color;
            ctx.font = '16px Press Start 2P';
            ctx.textAlign = 'center';
            ctx.fillText('W', 0, 6);

            ctx.restore();
        }

        // ===== DIBUJAR BALA =====
        function drawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);

            if (bullet.type === 'missile') {
                // Misil
                ctx.fillStyle = '#ff6600';
                ctx.beginPath();
                ctx.moveTo(0, -12);
                ctx.lineTo(5, 5);
                ctx.lineTo(3, 8);
                ctx.lineTo(-3, 8);
                ctx.lineTo(-5, 5);
                ctx.closePath();
                ctx.fill();

                // Llama del misil
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.moveTo(-2, 8);
                ctx.lineTo(0, 15 + Math.random() * 5);
                ctx.lineTo(2, 8);
                ctx.fill();
            } else if (bullet.type === 'laser') {
                // L√°ser
                ctx.fillStyle = '#ff00ff';
                ctx.shadowColor = '#ff00ff';
                ctx.shadowBlur = 10;
                ctx.fillRect(-2, -15, 4, 30);
            } else if (bullet.type === 'plasma') {
                // Plasma - esfera brillante que atraviesa
                ctx.fillStyle = '#00ffaa';
                ctx.shadowColor = '#00ffaa';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(0, 0, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(0, 0, 4, 0, Math.PI * 2);
                ctx.fill();
            } else if (bullet.type === 'flame') {
                // Llama
                const size = bullet.life ? bullet.life / 2 : 5;
                ctx.fillStyle = `rgba(255, ${50 + Math.random() * 100}, 0, ${bullet.life ? bullet.life / 20 : 1})`;
                ctx.beginPath();
                ctx.arc(0, 0, size, 0, Math.PI * 2);
                ctx.fill();
            } else if (bullet.type === 'lightning') {
                // Rayo
                ctx.strokeStyle = '#aaaaff';
                ctx.shadowColor = '#aaaaff';
                ctx.shadowBlur = 15;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, -20);
                for (let i = 0; i < 4; i++) {
                    ctx.lineTo((Math.random() - 0.5) * 15, -20 + i * 10);
                }
                ctx.lineTo(0, 20);
                ctx.stroke();
            } else if (bullet.type === 'bomb') {
                // Bomba
                ctx.fillStyle = '#333333';
                ctx.beginPath();
                ctx.arc(0, 0, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(0, -5, 4, 0, Math.PI * 2);
                ctx.fill();
                // Mecha
                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, -10);
                ctx.lineTo(0, -15);
                ctx.stroke();
                // Chispa
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.arc(0, -15, 3 + Math.random() * 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // Bala normal
                ctx.fillStyle = bullet.color || '#ffff00';
                ctx.shadowColor = bullet.color || '#ffff00';
                ctx.shadowBlur = 5;
                ctx.beginPath();
                ctx.ellipse(0, 0, 3, 8, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }

        // ===== CREAR ENEMIGO =====
        function spawnEnemy() {
            const config = levelConfig[level];

            // Nivel 7 es boss
            if (config.boss && !boss) {
                spawnBoss();
                return;
            }

            if (config.boss) return; // No spawn normal en nivel boss

            const availableTypes = config.types;
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            const pterType = pterosaurTypes[type];

            enemies.push({
                id: Date.now() + Math.random(),
                type: type,
                x: Math.random() * (canvas.width - 100) + 50,
                y: -50,
                health: pterType.health * config.multiplier,
                speed: pterType.speed * config.multiplier,
                pattern: pterType.pattern,
                phase: Math.random() * Math.PI * 2,
                targetX: player.x
            });
        }

        // ===== CREAR BOSS =====
        function spawnBoss() {
            const bossType = pterosaurTypes.boss;
            boss = {
                id: Date.now(),
                type: 'boss',
                x: canvas.width / 2,
                y: -100,
                health: bossType.health,
                maxHealth: bossType.health,
                speed: bossType.speed,
                pattern: 'boss',
                phase: 0,
                attackTimer: 0,
                state: 'entering' // entering, fighting, rage
            };
            enemies.push(boss);
        }

        // ===== DIBUJAR BOSS =====
        function drawBoss(enemy) {
            ctx.save();
            ctx.translate(enemy.x, enemy.y);

            const wingFlap = Math.sin(Date.now() / 150 + enemy.id) * 25;
            const rage = enemy.state === 'rage';
            const baseColor = rage ? '#ff0000' : '#8B0000';

            // Aura de poder
            if (rage) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
                ctx.beginPath();
                ctx.arc(0, 0, 120 + Math.sin(Date.now() / 100) * 10, 0, Math.PI * 2);
                ctx.fill();
            }

            // Alas gigantes
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.moveTo(-10, 0);
            ctx.quadraticCurveTo(-100, -30 + wingFlap, -90, 20 + wingFlap);
            ctx.quadraticCurveTo(-50, 30, -10, 10);
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(10, 0);
            ctx.quadraticCurveTo(100, -30 + wingFlap, 90, 20 + wingFlap);
            ctx.quadraticCurveTo(50, 30, 10, 10);
            ctx.fill();

            // Cuerpo masivo
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.ellipse(0, 10, 30, 50, 0, 0, Math.PI * 2);
            ctx.fill();

            // Cabeza con cresta enorme
            ctx.beginPath();
            ctx.ellipse(0, -40, 20, 25, 0, 0, Math.PI * 2);
            ctx.fill();

            // Cresta gigante
            ctx.fillStyle = rage ? '#ff4400' : '#660000';
            ctx.beginPath();
            ctx.moveTo(0, -55);
            ctx.lineTo(-50, -70);
            ctx.lineTo(-10, -50);
            ctx.closePath();
            ctx.fill();

            // Pico enorme
            ctx.fillStyle = '#ffaa00';
            ctx.beginPath();
            ctx.moveTo(0, -40);
            ctx.lineTo(-8, -25);
            ctx.lineTo(0, 20);
            ctx.lineTo(8, -25);
            ctx.closePath();
            ctx.fill();

            // Ojos rojos brillantes
            ctx.fillStyle = rage ? '#ffff00' : '#ff0000';
            ctx.shadowColor = ctx.fillStyle;
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(-10, -45, 6, 0, Math.PI * 2);
            ctx.arc(10, -45, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Pupilas
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-10, -45, 3, 0, Math.PI * 2);
            ctx.arc(10, -45, 3, 0, Math.PI * 2);
            ctx.fill();

            // Garras
            ctx.strokeStyle = '#440000';
            ctx.lineWidth = 5;
            for (let i = -1; i <= 1; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 15, 55);
                ctx.lineTo(i * 20, 75);
                ctx.stroke();
            }

            // Barra de vida del boss (grande)
            const healthPercent = enemy.health / enemy.maxHealth;
            ctx.fillStyle = '#330000';
            ctx.fillRect(-80, -90, 160, 12);
            ctx.fillStyle = healthPercent > 0.5 ? '#00ff00' : healthPercent > 0.25 ? '#ffff00' : '#ff0000';
            ctx.fillRect(-80, -90, 160 * healthPercent, 12);

            // Nombre del boss
            ctx.fillStyle = '#ffffff';
            ctx.font = '8px Press Start 2P';
            ctx.textAlign = 'center';
            ctx.fillText('MEGA QUETZALCOATLUS', 0, -100);

            ctx.restore();
        }

        // ===== CREAR POWER-UP =====
        function spawnPowerup() {
            const isHealth = Math.random() < 0.5;

            if (isHealth) {
                powerups.push({
                    type: 'health',
                    x: Math.random() * (canvas.width - 60) + 30,
                    y: -30,
                    speed: 2
                });
            } else {
                // Armas disponibles seg√∫n nivel
                let weaponTypes = ['double', 'spread'];
                if (level >= 2) weaponTypes.push('laser');
                if (level >= 3) weaponTypes.push('missile', 'plasma');
                if (level >= 4) weaponTypes.push('flame');
                if (level >= 5) weaponTypes.push('lightning');
                if (level >= 6) weaponTypes.push('bomb');

                powerups.push({
                    type: 'weapon',
                    weaponType: weaponTypes[Math.floor(Math.random() * weaponTypes.length)],
                    x: Math.random() * (canvas.width - 60) + 30,
                    y: -30,
                    speed: 2
                });
            }
        }

        // ===== DISPARAR =====
        function shoot() {
            const now = Date.now();
            const weapon = weapons[player.weapon];

            if (now - lastShot < weapon.delay) return;
            lastShot = now;

            playSound(weapon.sound);

            switch(player.weapon) {
                case 'machinegun':
                    bullets.push({
                        x: player.x,
                        y: player.y - 30,
                        vx: 0,
                        vy: -12,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'normal'
                    });
                    break;

                case 'double':
                    bullets.push({
                        x: player.x - 15,
                        y: player.y - 20,
                        vx: 0,
                        vy: -12,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'normal'
                    });
                    bullets.push({
                        x: player.x + 15,
                        y: player.y - 20,
                        vx: 0,
                        vy: -12,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'normal'
                    });
                    break;

                case 'spread':
                    for (let angle = -20; angle <= 20; angle += 20) {
                        const rad = angle * Math.PI / 180;
                        bullets.push({
                            x: player.x,
                            y: player.y - 20,
                            vx: Math.sin(rad) * 8,
                            vy: -Math.cos(rad) * 12,
                            damage: weapon.damage * player.weaponLevel,
                            color: weapon.color,
                            type: 'normal'
                        });
                    }
                    break;

                case 'laser':
                    bullets.push({
                        x: player.x,
                        y: player.y - 30,
                        vx: 0,
                        vy: -18,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'laser'
                    });
                    break;

                case 'missile':
                    bullets.push({
                        x: player.x,
                        y: player.y - 30,
                        vx: 0,
                        vy: -8,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'missile',
                        target: findNearestEnemy()
                    });
                    break;

                case 'plasma':
                    // Plasma atraviesa enemigos
                    bullets.push({
                        x: player.x,
                        y: player.y - 30,
                        vx: 0,
                        vy: -14,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'plasma',
                        piercing: true
                    });
                    break;

                case 'flame':
                    // Lanzallamas - muchas part√≠culas
                    for (let i = 0; i < 3; i++) {
                        bullets.push({
                            x: player.x + (Math.random() - 0.5) * 20,
                            y: player.y - 20,
                            vx: (Math.random() - 0.5) * 3,
                            vy: -10 - Math.random() * 4,
                            damage: weapon.damage * player.weaponLevel,
                            color: weapon.color,
                            type: 'flame',
                            life: 20
                        });
                    }
                    break;

                case 'lightning':
                    // Rayo que hace cadena
                    bullets.push({
                        x: player.x,
                        y: player.y - 30,
                        vx: 0,
                        vy: -16,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'lightning',
                        chainCount: 3
                    });
                    break;

                case 'bomb':
                    // Bomba con explosi√≥n de √°rea
                    bullets.push({
                        x: player.x,
                        y: player.y - 30,
                        vx: 0,
                        vy: -6,
                        damage: weapon.damage * player.weaponLevel,
                        color: weapon.color,
                        type: 'bomb',
                        explosionRadius: 80
                    });
                    break;
            }
        }

        function findNearestEnemy() {
            let nearest = null;
            let minDist = Infinity;

            for (const enemy of enemies) {
                const dist = Math.hypot(enemy.x - player.x, enemy.y - player.y);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = enemy;
                }
            }

            return nearest;
        }

        // ===== CREAR EXPLOSI√ìN =====
        function createExplosion(x, y, size) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 30,
                    maxLife: 30,
                    size: Math.random() * size + 2,
                    color: ['#ff0000', '#ff6600', '#ffff00', '#ffffff'][Math.floor(Math.random() * 4)]
                });
            }
        }

        // ===== ACTUALIZAR NUBES =====
        function updateClouds() {
            // Crear nubes
            if (Math.random() < 0.02) {
                clouds.push({
                    x: Math.random() * canvas.width,
                    y: -50,
                    width: 80 + Math.random() * 120,
                    height: 40 + Math.random() * 60,
                    speed: 0.5 + Math.random() * 1
                });
            }

            // Mover nubes
            for (let i = clouds.length - 1; i >= 0; i--) {
                clouds[i].y += clouds[i].speed;
                if (clouds[i].y > canvas.height + 100) {
                    clouds.splice(i, 1);
                }
            }
        }

        // ===== DIBUJAR FONDO =====
        function drawBackground() {
            // Cielo degradado
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#000033');
            gradient.addColorStop(0.5, '#003366');
            gradient.addColorStop(1, '#006699');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Nubes
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            for (const cloud of clouds) {
                ctx.beginPath();
                ctx.ellipse(cloud.x, cloud.y, cloud.width/2, cloud.height/2, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Estrellas (solo en la parte superior)
            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 50; i++) {
                const x = (i * 137) % canvas.width;
                const y = (i * 89) % (canvas.height / 2);
                const twinkle = Math.sin(Date.now() / 500 + i) * 0.5 + 0.5;
                ctx.globalAlpha = twinkle;
                ctx.beginPath();
                ctx.arc(x, y, 1, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }

        // ===== ACTUALIZAR JUEGO =====
        function update() {
            if (!gameRunning || gamePaused) return;

            const now = Date.now();

            // Mover jugador
            if (keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
            if (keys['ArrowRight'] || keys['d']) player.x += player.speed;
            if (keys['ArrowUp'] || keys['w']) player.y -= player.speed;
            if (keys['ArrowDown'] || keys['s']) player.y += player.speed;

            // L√≠mites
            player.x = Math.max(30, Math.min(canvas.width - 30, player.x));
            player.y = Math.max(50, Math.min(canvas.height - 50, player.y));

            // Disparar
            if (keys[' ']) shoot();

            // Invulnerabilidad
            if (player.invulnerable && now > player.invulnerableTime) {
                player.invulnerable = false;
            }

            // Spawn enemigos usando configuraci√≥n de nivel
            const config = levelConfig[level];
            if (now - lastEnemySpawn > config.spawnDelay) {
                spawnEnemy();
                lastEnemySpawn = now;
            }

            // Spawn powerups
            if (now - lastPowerupSpawn > powerupSpawnDelay) {
                spawnPowerup();
                lastPowerupSpawn = now;
            }

            // Actualizar nubes
            updateClouds();

            // Actualizar balas
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];

                // Llamas tienen vida limitada
                if (bullet.type === 'flame') {
                    bullet.life--;
                    if (bullet.life <= 0) {
                        bullets.splice(i, 1);
                        continue;
                    }
                }

                // Misiles persiguen objetivo
                if (bullet.type === 'missile' && bullet.target && enemies.includes(bullet.target)) {
                    const dx = bullet.target.x - bullet.x;
                    const dy = bullet.target.y - bullet.y;
                    const dist = Math.hypot(dx, dy);
                    if (dist > 0) {
                        bullet.vx += (dx / dist) * 0.5;
                        bullet.vy += (dy / dist) * 0.5;
                        const speed = Math.hypot(bullet.vx, bullet.vy);
                        if (speed > 10) {
                            bullet.vx = (bullet.vx / speed) * 10;
                            bullet.vy = (bullet.vy / speed) * 10;
                        }
                    }
                }

                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                if (bullet.y < -20 || bullet.y > canvas.height + 20 ||
                    bullet.x < -20 || bullet.x > canvas.width + 20) {
                    bullets.splice(i, 1);
                    continue;
                }

                // Colisi√≥n con enemigos
                let bulletHit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    const type = pterosaurTypes[enemy.type];

                    if (Math.abs(bullet.x - enemy.x) < type.width/2 &&
                        Math.abs(bullet.y - enemy.y) < type.height/2) {

                        // Bomba explota y da√±a √°rea
                        if (bullet.type === 'bomb') {
                            createExplosion(bullet.x, bullet.y, 15);
                            playSound('explosion');
                            // Da√±ar todos los enemigos en el radio
                            for (let k = enemies.length - 1; k >= 0; k--) {
                                const e = enemies[k];
                                const dist = Math.hypot(e.x - bullet.x, e.y - bullet.y);
                                if (dist < bullet.explosionRadius) {
                                    e.health -= bullet.damage * (1 - dist / bullet.explosionRadius);
                                    if (e.health <= 0) {
                                        createExplosion(e.x, e.y, 8);
                                        score += pterosaurTypes[e.type].points * level;
                                        killCount++;
                                        levelKills++;
                                        if (e === boss) boss = null;
                                        enemies.splice(k, 1);
                                    }
                                }
                            }
                            bullets.splice(i, 1);
                            checkLevelProgress();
                            break;
                        }

                        enemy.health -= bullet.damage;

                        // Boss entra en rage cuando tiene poca vida
                        if (enemy.type === 'boss' && enemy.health < enemy.maxHealth * 0.3) {
                            enemy.state = 'rage';
                        }

                        // Plasma no se destruye al impactar
                        if (!bullet.piercing) {
                            bulletHit = true;
                        }

                        playSound('hit');

                        // Part√≠culas de impacto
                        for (let k = 0; k < 5; k++) {
                            particles.push({
                                x: bullet.x,
                                y: bullet.y,
                                vx: (Math.random() - 0.5) * 5,
                                vy: (Math.random() - 0.5) * 5,
                                life: 15,
                                maxLife: 15,
                                size: 3,
                                color: type.color
                            });
                        }

                        if (enemy.health <= 0) {
                            createExplosion(enemy.x, enemy.y, enemy.type === 'boss' ? 20 : 8);
                            playSound('explosion');
                            score += type.points * level;
                            killCount++;
                            levelKills++;
                            if (enemy === boss) boss = null;
                            enemies.splice(j, 1);
                            checkLevelProgress();
                        }

                        if (bulletHit) break;
                    }
                }
                if (bulletHit) {
                    bullets.splice(i, 1);
                }
            }

            // Funci√≥n para verificar progreso de nivel
            function checkLevelProgress() {
                const config = levelConfig[level];
                if (levelKills >= config.kills && level < 7) {
                    levelUp();
                } else if (level === 7 && !boss && levelKills >= 1) {
                    victory();
                }
            }

            // Actualizar enemigos
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];

                // Movimiento seg√∫n patr√≥n
                switch(enemy.pattern) {
                    case 'straight':
                        enemy.y += enemy.speed;
                        break;
                    case 'zigzag':
                        enemy.y += enemy.speed;
                        enemy.x += Math.sin(enemy.y / 30 + enemy.phase) * 3;
                        break;
                    case 'dive':
                        enemy.y += enemy.speed;
                        if (enemy.y > canvas.height / 3) {
                            const dx = player.x - enemy.x;
                            enemy.x += dx * 0.02;
                            enemy.speed = Math.min(enemy.speed + 0.05, 6);
                        }
                        break;
                    case 'swoop':
                        enemy.phase += 0.03;
                        enemy.x += Math.sin(enemy.phase) * 4;
                        enemy.y += enemy.speed;
                        break;
                    case 'boss':
                        // Boss entra desde arriba
                        if (enemy.state === 'entering') {
                            enemy.y += 1;
                            if (enemy.y >= 120) {
                                enemy.state = 'fighting';
                            }
                        } else {
                            // Movimiento lateral
                            enemy.phase += enemy.state === 'rage' ? 0.04 : 0.02;
                            enemy.x = canvas.width / 2 + Math.sin(enemy.phase) * 200;

                            // Boss ataca peri√≥dicamente
                            enemy.attackTimer++;
                            const attackInterval = enemy.state === 'rage' ? 60 : 120;
                            if (enemy.attackTimer >= attackInterval) {
                                enemy.attackTimer = 0;
                                bossAttack(enemy);
                            }
                        }
                        break;
                }

                // L√≠mites laterales
                enemy.x = Math.max(30, Math.min(canvas.width - 30, enemy.x));

                // Fuera de pantalla
                if (enemy.y > canvas.height + 50) {
                    enemies.splice(i, 1);
                    continue;
                }

                // Colisi√≥n con jugador
                if (!player.invulnerable) {
                    const type = pterosaurTypes[enemy.type];
                    if (Math.abs(enemy.x - player.x) < (type.width/2 + 20) &&
                        Math.abs(enemy.y - player.y) < (type.height/2 + 25)) {

                        player.health -= 25;
                        player.invulnerable = true;
                        player.invulnerableTime = now + 2000;
                        playSound('damage');
                        createExplosion(player.x, player.y, 5);

                        if (player.health <= 0) {
                            gameOver();
                            return;
                        }

                        updateHUD();
                    }
                }
            }

            // Actualizar powerups
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                powerup.y += powerup.speed;

                if (powerup.y > canvas.height + 50) {
                    powerups.splice(i, 1);
                    continue;
                }

                // Colisi√≥n con jugador
                if (Math.abs(powerup.x - player.x) < 35 &&
                    Math.abs(powerup.y - player.y) < 40) {

                    playSound('powerup');

                    if (powerup.type === 'health') {
                        player.health = Math.min(player.maxHealth, player.health + 30);
                    } else if (powerup.type === 'weapon') {
                        player.weapon = powerup.weaponType;
                        player.weaponLevel = Math.min(player.weaponLevel + 1, 3);
                    }

                    powerups.splice(i, 1);
                    updateHUD();
                }
            }

            // Actualizar part√≠culas
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx || 0;
                p.y += p.vy || 0;
                p.life--;

                // Part√≠culas da√±inas del boss
                if (p.damaging && !player.invulnerable) {
                    if (Math.abs(p.x - player.x) < 25 && Math.abs(p.y - player.y) < 30) {
                        player.health -= 15;
                        player.invulnerable = true;
                        player.invulnerableTime = now + 1500;
                        playSound('damage');
                        createExplosion(player.x, player.y, 5);
                        particles.splice(i, 1);

                        if (player.health <= 0) {
                            gameOver();
                            return;
                        }
                        updateHUD();
                        continue;
                    }
                }

                if (p.life <= 0 || p.y > canvas.height + 50 || p.y < -50 || p.x < -50 || p.x > canvas.width + 50) {
                    particles.splice(i, 1);
                }
            }
        }

        // ===== ATAQUE DEL BOSS =====
        function bossAttack(bossEnemy) {
            const rage = bossEnemy.state === 'rage';

            // Lanza pterosaurios peque√±os
            if (rage) {
                // En rage, dispara en abanico
                for (let angle = -40; angle <= 40; angle += 20) {
                    const rad = (angle + 90) * Math.PI / 180;
                    particles.push({
                        x: bossEnemy.x,
                        y: bossEnemy.y + 50,
                        vx: Math.cos(rad) * 6,
                        vy: Math.sin(rad) * 6,
                        life: 60,
                        maxLife: 60,
                        size: 8,
                        color: '#ff0000',
                        damaging: true
                    });
                }
            } else {
                // Normal: dispara hacia el jugador
                const dx = player.x - bossEnemy.x;
                const dy = player.y - bossEnemy.y;
                const dist = Math.hypot(dx, dy);
                particles.push({
                    x: bossEnemy.x,
                    y: bossEnemy.y + 50,
                    vx: (dx / dist) * 5,
                    vy: (dy / dist) * 5,
                    life: 80,
                    maxLife: 80,
                    size: 10,
                    color: '#ff4400',
                    damaging: true
                });
            }
            playSound('missile');
        }

        // ===== SUBIR DE NIVEL =====
        function levelUp() {
            if (level >= 7) return; // Ya en nivel m√°ximo

            level++;
            levelKills = 0; // Reset kills del nivel
            playSound('levelup');

            const config = levelConfig[level];
            const popup = document.getElementById('levelPopup');
            popup.innerHTML = '¬°NIVEL ' + level + '!<br><span style="font-size: 12px; color: #ffaa00;">' + config.name + '</span>';
            popup.style.display = 'block';

            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);

            updateHUD();
        }

        // ===== DIBUJAR =====
        function draw() {
            // Fondo
            drawBackground();

            // Part√≠culas (detr√°s de todo)
            for (const p of particles) {
                ctx.globalAlpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // Powerups
            for (const powerup of powerups) {
                if (powerup.type === 'health') {
                    drawHealthEgg(powerup);
                } else {
                    drawWeaponPowerup(powerup);
                }
            }

            // Balas
            for (const bullet of bullets) {
                drawBullet(bullet);
            }

            // Enemigos
            for (const enemy of enemies) {
                if (enemy.type === 'boss') {
                    drawBoss(enemy);
                } else {
                    drawPterosaurus(enemy);
                }
            }

            // Jugador
            drawPlayer();
        }

        // ===== ACTUALIZAR HUD =====
        function updateHUD() {
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('healthBar').style.width = (player.health / player.maxHealth * 100) + '%';
            document.getElementById('weaponDisplay').textContent = weapons[player.weapon].name;
            const config = levelConfig[level];
            document.getElementById('levelDisplay').innerHTML = level + '<br><span style="font-size:6px;color:#aaa;">' + config.name.substring(0, 10) + '</span>';
        }

        // ===== GAME OVER =====
        function gameOver() {
            gameRunning = false;
            playSound('gameover');

            document.getElementById('finalScore').textContent = score;
            document.getElementById('killCount').textContent = killCount;
            document.getElementById('gameOverScreen').style.display = 'block';
        }

        // ===== VICTORIA =====
        function victory() {
            gameRunning = false;
            playSound('levelup');

            document.getElementById('victoryScore').textContent = score;
            document.getElementById('victoryKills').textContent = killCount;
            document.getElementById('victoryScreen').style.display = 'block';
        }

        // ===== INICIAR JUEGO =====
        function startGame() {
            initAudio();

            // Reset estado
            player = {
                x: canvas.width / 2,
                y: canvas.height - 80,
                width: 50,
                height: 60,
                speed: 6,
                health: 100,
                maxHealth: 100,
                weapon: 'machinegun',
                weaponLevel: 1,
                invulnerable: false,
                invulnerableTime: 0
            };

            bullets = [];
            enemies = [];
            powerups = [];
            particles = [];
            clouds = [];
            boss = null;

            score = 0;
            level = 1;
            killCount = 0;
            levelKills = 0;
            difficultyMultiplier = 1;

            lastShot = 0;
            lastEnemySpawn = 0;
            lastPowerupSpawn = 0;

            updateHUD();

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('victoryScreen').style.display = 'none';

            gameRunning = true;
            gamePaused = false;
        }

        // ===== GAME LOOP =====
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // ===== CONTROLES =====
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;

            if (e.key === 'p' || e.key === 'P') {
                if (gameRunning) {
                    gamePaused = !gamePaused;
                    document.getElementById('pausedOverlay').style.display = gamePaused ? 'block' : 'none';
                }
            }

            if ([' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Iniciar loop
        gameLoop();
    </script>
</body>
</html>
